#!/bin/bash

# =======================================================
# GT-MARKDAWIN Unified Launcher, Stopper, and Cleaner
# =======================================================

PORT=8000
# ๐ ุงูุชุนุฏูู ููุง ูุชุถููู index.html ๐
SERVER_ADDRESS="http://127.0.0.1:$PORT/index.html"
PID_FILE="server.pid"

# ๐ ุงูุชุญุฏูุฏ ุงูุชููุงุฆู ููุณุงุฑ ุงูุจูุงูุงุช ุงููุคูุชุฉ ๐
BASE_DIR="${APPDIR:-.}"
DATA_DIR="$BASE_DIR/mnt/GTMarkdawinData"

# -------------------------------------------------------
# ุฏุงูุฉ ุฅููุงู ุงูุฎุงุฏู
# -------------------------------------------------------
stop_server() {
    echo "==========================================="
    echo "๐ ุฌุงุฑู ุฅููุงู ุงูุฎุงุฏู..."

    if [ -f "$PID_FILE" ]; then
        SERVER_PID=$(cat "$PID_FILE")
        echo "ุฅุฑุณุงู ุฅุดุงุฑุฉ ุงูุฅููุงู (SIGTERM) ุฅูู ุงูุนูููุฉ $SERVER_PID..."
        kill -TERM "$SERVER_PID" 2>/dev/null

        sleep 1
        if ! kill -0 "$SERVER_PID" 2> /dev/null; then
            echo "โ ุชู ุฅููุงู ุงูุฎุงุฏู ุจูุฌุงุญ."
            rm -f "$PID_FILE"
            return 0
        else
            echo "โ๏ธ ูุดู ุงูุฅููุงู ุจู SIGTERM. ุงูุฅููุงู ุงููุณุฑู (SIGKILL)."
            kill -9 "$SERVER_PID" 2>/dev/null
            rm -f "$PID_FILE"
            return 0
        fi
    else
        echo "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ููู PID. ุงูุฎุงุฏู ูุฏ ูุง ูููู ููุฏ ุงูุชุดุบูู."
        return 1
    fi
}

# -------------------------------------------------------
# ุฏุงูุฉ ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ
# -------------------------------------------------------
cleanup_data() {
    echo "==========================================="
    echo "๐งน ุฌุงุฑู ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ..."
    # ุญุฐู ูุฌูุฏ ุงูุจูุงูุงุช ุงููุคูุชุฉ ุจุงููุงูู
    if [ -d "$DATA_DIR" ]; then
        rm -rf "$DATA_DIR"
        echo "โ ุชู ุญุฐู ูุฌูุฏ ุงูุจูุงูุงุช ุงููุคูุชุฉ: $DATA_DIR"
    else
        echo "โ๏ธ ูุฌูุฏ ุงูุจูุงูุงุช ุงููุคูุชุฉ $DATA_DIR ุบูุฑ ููุฌูุฏ. ูุง ุญุงุฌุฉ ููุชูุธูู."
    fi
    # ุญุฐู ูููุงุช ุชุซุจูุช ุงูุฎุทูุท ูุงูุฅูููุฌู ุฅู ูุฌุฏุช (ูุฌุจ ุฃู ูุชู ุชุญุฏูุซ ูุฐู ุงูุนูุงูุงุช ูุงุญูุงู)
    rm -f ./.fonts_installed ./.emojis_downloaded
    echo "โ ุชู ุชูุธูู ุนูุงูุงุช ุงูุชุญููู (ููุท)."
}

# -------------------------------------------------------
# ุฏุงูุฉ ูุญุต ูุชุญููู ุงูุฅูููุฌู (ุงูุชุนุฏูู ุงููุทููุจ)
# -------------------------------------------------------
check_and_download_emojis() {
    EMOJIS_BASE_DIR="emojis"
    SVG_DIR="$EMOJIS_BASE_DIR/svg"
    PNG_DIR="$EMOJIS_BASE_DIR/72x72"
    EMOJIS_JSON="emojis.json"
    # ูุตุฏุฑ Twemoji v14ุ ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ
    TWEMOJI_CDN="https://cdn.jsdelivr.net/gh/twitter/twemoji@14/assets"

    echo "============================================"
    echo "๐ ูุญุต ูููุงุช ุงูุฅูููุฌู..."

    # ุงูุดุฑุท: ูุญุต ูุฌูุฏ ูุฌูุฏ ุงูุฅูููุฌู ุงูุฑุฆูุณู ูุงููุฌูุฏูู ุงููุฑุนููู (svg ู 72x72)
    if [[ -d "$EMOJIS_BASE_DIR" && -d "$SVG_DIR" && -d "$PNG_DIR" ]]; then
        echo "โ ูุฌูุฏุงุช ุงูุฅูููุฌู ููุฌูุฏุฉ ($SVG_DIR ู $PNG_DIR). ุชุฎุทู ุงูุชุญููู."
        return 0
    fi

    # ุฅุฐุง ูู ุชูู ุงููุฌูุฏุงุช ููุฌูุฏุฉุ ูุจุฏุฃ ุจุงูุชุญููู
    echo "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฌูุฏุงุช ุงูุฅูููุฌู ุงููุทููุจุฉ. ุฌุงุฑู ุงูุชุญุถูุฑ ููุชุญููู."

    # ุฅูุดุงุก ุงููุฌูุฏุงุช
    mkdir -p "$SVG_DIR" "$PNG_DIR"

    # ุงูุชุญูู ูู ูุฌูุฏ ููู emojis.json ููุงุฆูุฉ ุงูุฅูููุฌู
    if [[ ! -f "$EMOJIS_JSON" ]]; then
        echo "โ ูุง ูููู ุงูุนุซูุฑ ุนูู ููู $EMOJIS_JSON ูุชุญุฏูุฏ ุงูุฅูููุฌู ุงููุฑุงุฏ ุชุญููููุง."
        echo "   ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ูุฌูุฏู ูู ููุณ ุงููุณุงุฑ. ูุง ูููู ุงููุชุงุจุนุฉ."
        # ุญุฐู ุงููุฌูุฏุงุช ุงููุงุฑุบุฉ ุงูุชู ุชู ุฅูุดุงุคูุง
        rmdir --ignore-fail-on-non-empty "$SVG_DIR" "$PNG_DIR" "$EMOJIS_BASE_DIR" 2>/dev/null
        return 1
    fi

    # ุงุณุชุฎุฑุงุฌ ุฃุณูุงุก ูููุงุช ุงูุฅูููุฌู (ูุซู 1f004) ูู ููู JSON
    # ูุณุชุฎุฏู jq ูุงุณุชุฎุฑุงุฌ ููู ุญูู 'name' - ููู ุงูุฃูุซุฑ ุฏูุฉ
    if command -v jq &> /dev/null; then
        EMOJI_LIST=$(jq -r '.[].name' "$EMOJIS_JSON" 2>/dev/null)
        if [ $? -ne 0 ] || [ -z "$EMOJI_LIST" ]; then
            echo "โ ูุดู ุชุญููู ููู $EMOJIS_JSON ุจูุงุณุทุฉ jq. ุชุญูู ูู ุตูุบุฉ ุงูููู."
            return 1
        fi
    elif command -v grep &> /dev/null && command -v sed &> /dev/null; then
        # ุจุฏูู ูู jq (ุฃูู ุฏูุฉ ูููู ูุฏ ูุนูู) - ุงูุจุญุซ ุนู "name": "..."
        echo "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู 'jq'. ุงุณุชุฎุฏุงู ุทุฑููุฉ ุชุญููู ุงุญุชูุงุทูุฉ (grep/sed)."
        # ุงุณุชุฎุฏุงู grep ู sed ูุงุณุชุฎุฑุงุฌ ูููุฉ "name"
        EMOJI_LIST=$(grep -o '"name": *"[^"]*"' "$EMOJIS_JSON" | sed 's/.*"\([^"]*\)".*/\1/g')
        if [ -z "$EMOJI_LIST" ]; then
            echo "โ ูุดู ุชุญููู ููู $EMOJIS_JSON ุจุงูุทุฑููุฉ ุงูุงุญุชูุงุทูุฉ. ูุง ูููู ุงููุชุงุจุนุฉ."
            return 1
        fi
    else
        echo "โ ูุง ูููู ุชุญููู ููู $EMOJIS_JSON. ูุทููุจ ุฅูุง 'jq' ุฃู 'grep' ู 'sed'."
        return 1
    fi

    echo "๐ฆ ุฌุงุฑู ุชุญููู ูููุงุช ุงูุฅูููุฌู (ุนุฏุฏ ุงูุฅุฏุฎุงูุงุช: $(echo "$EMOJI_LIST" | wc -l))... ูุฏ ูุณุชุบุฑู ุงูุฃูุฑ ุจุนุถ ุงูููุช."
    # ูุณุชุฎุฏู wget ููุชุญููู ุงูุตุงูุช (q) ูุน ุฅุฎูุงุก ุฑุณุงุฆู ุงูุฃุฎุทุงุก ุงูุจุณูุทุฉ
    DOWNLOADED_COUNT=0

    for filename in $EMOJI_LIST; do
        SVG_URL="$TWEMOJI_CDN/svg/$filename.svg"
        PNG_URL="$TWEMOJI_CDN/72x72/$filename.png"

        # ุชุญููู SVG
        wget -q -O "$SVG_DIR/$filename.svg" "$SVG_URL"
        if [ $? -eq 0 ]; then DOWNLOADED_COUNT=$((DOWNLOADED_COUNT + 1)); fi

        # ุชุญููู PNG (72x72)
        wget -q -O "$PNG_DIR/$filename.png" "$PNG_URL"
        if [ $? -eq 0 ]; then DOWNLOADED_COUNT=$((DOWNLOADED_COUNT + 1)); fi
    done

    # ูุชู ุชูุฒูู ููููู ููู ุฅูููุฌู (SVG ู PNG)ุ ูุฐุง ูุฌุจ ุฃู ูููู ุงูุนุฏุฏ ุงูุฅุฌูุงูู ูู ุงูุถุนู
    TOTAL_EMOJIS=$(echo "$EMOJI_LIST" | wc -l)
    EXPECTED_FILES=$((TOTAL_EMOJIS * 2))

    echo ""
    echo "============================================"
    echo "๐ ุฅุญุตุงุฆูุงุช ุชุญููู ุงูุฅูููุฌู:"
    echo "   ุนุฏุฏ ุงูุฅูููุฌู ุงูููุชุดู ูู JSON: $TOTAL_EMOJIS"
    echo "   ุนุฏุฏ ุงููููุงุช ุงููุชููุน ุชุญููููุง: $EXPECTED_FILES"
    echo "   ุนุฏุฏ ุงููููุงุช ุงูุชู ุชู ุชุญููููุง ุจูุฌุงุญ: $DOWNLOADED_COUNT"

    if [ "$DOWNLOADED_COUNT" -eq "$EXPECTED_FILES" ]; then
        echo "โ ุงูุชูู ุชุญููู ุฌููุน ูููุงุช ุงูุฅูููุฌู ุจูุฌุงุญ."
    elif [ "$DOWNLOADED_COUNT" -gt 0 ]; then
        echo "โ๏ธ ุชู ุชุญููู $DOWNLOADED_COUNT ููู ุฅูููุฌู. ูุฏ ุชููู ููุงู ูููุงุช ููููุฏุฉ."
    else
        echo "โ ูุดู ุชุญููู ุฃู ูููุงุช ุฅูููุฌู. ุชุญูู ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ููู ุฃุฏุงุฉ wget/curl."
        return 1
    fi

    return 0
}


# -------------------------------------------------------
# ุฏุงูุฉ ุจุฏุก ุชุดุบูู ุงูุฎุงุฏู
# -------------------------------------------------------
start_server() {
    echo "==========================================="
    echo "๐ ุฌุงุฑู ุชุดุบูู ุฎุงุฏู ุจุงูุซูู 3 HTTP ุนูู ุงููููุฐ $PORT..."
    echo "ุนููุงู ุงูุชุดุบูู: $SERVER_ADDRESS"

    # ุงุณุชุฎุฏุงู & ูุชุดุบูู ุงูุฎุงุฏู ูู ุงูุฎูููุฉ
    python3 -m http.server $PORT &
    SERVER_PID=$!
    echo "$SERVER_PID" > "$PID_FILE"
    echo "โ ุชู ุชุดุบูู ุงูุฎุงุฏู ุจุงูุฑูู ุงูุชุนุฑููู: $SERVER_PID"
    return 0
}

# ------------------------------------------------------
# 1. ุชููุฆุฉ ููุญุต ุงูุจูุงูุงุช (INITIALIZATION)
# ------------------------------------------------------

echo "==========================================="
echo "โ๏ธ ูุฑุญูุฉ ุงูุชููุฆุฉ ูุงููุญุต..."

# 1.1 ูุญุต ูุชุญููู ุงูุฅูููุฌู
if ! check_and_download_emojis; then
    echo "โ ูุดู ูู ูุญุต/ุชุญููู ูููุงุช ุงูุฅูููุฌู. ูุง ูููู ุชุดุบูู ุงูุชุทุจูู."
    exit 1
fi

# (ููุง ููููู ุฅุถุงูุฉ ูุญุต ุงูุฎุทูุท ุฅุฐุง ูุงูุช ููุงู ุญุงุฌุฉ ููุง)
# # 1.2 ูุญุต ูุชุซุจูุช ุงูุฎุทูุท
# ensure_fonts_downloaded

# 1.3 ุจุฏุก ุชุดุบูู ุงูุฎุงุฏู
if ! start_server; then
    echo "โ ูุดู ูู ุจุฏุก ุชุดุบูู ุงูุฎุงุฏู. ุงูุฎุฑูุฌ."
    exit 1
fi

echo "============================================"
echo "๐ ุณูุชู ูุญุงููุฉ ูุชุญ ุงููุชุตูุญ ุงูุขู..."

# 1.4 ูุชุญ ุงููุชุตูุญ ุนูู ุงูุนููุงู ุงูุตุญูุญ
if command -v xdg-open > /dev/null; then
    xdg-open "$SERVER_ADDRESS"
elif command -v open > /dev/null; then
    open "$SERVER_ADDRESS"
elif command -v start > /dev/null; then
    start "$SERVER_ADDRESS"
else
    echo "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุฏุงุฉ ูุชุญ ุงููุชุตูุญ. ุงูุฑุฌุงุก ูุชุญ ุงููุชุตูุญ ูุฏููุงู ุนูู: $SERVER_ADDRESS"
fi

echo "============================================"
echo "ุงูุนูููุงุช ุงูุฏุงุฎููุฉ ููุฎุงุฏู ุณุชุธูุฑ ููุง..."
echo "============================================"

# ------------------------------------------------------
# 2. ุญููุฉ ุงูุฅุบูุงู ูุงูุฎูุงุฑุงุช (SHUTDOWN LOOP)
# ------------------------------------------------------
PS3='ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุฅุฌุฑุงุก ุงููุทููุจ: '
options=("ุฅููุงู ุงูุฎุงุฏู ููุท (Stop Server Only)" "ุฅููุงู ุงูุฎุงุฏู ูุชูุธูู ุงููููุงุช ุงููุคูุชุฉ (Stop & Cleanup)" "ุฅูุบุงุก ุงูุฃูุฑ ูุงูุนูุฏุฉ (Cancel & Continue)")

# ุญููุฉ ุนุฑุถ ูุงุฆูุฉ ุงูุงุฎุชูุงุฑุงุช
while true; do
    echo ""
    echo "============================================"
    echo "ุฎูุงุฑุงุช ุงูุฅุบูุงู: (ุงุถุบุท ุงูุฑูู ุซู Enter)"
    select choice in "${options[@]}"; do
        case $choice in
            "ุฅููุงู ุงูุฎุงุฏู ููุท (Stop Server Only)")
                stop_server
                echo "ุชู ุงูุฅุบูุงู. ููููู ุงูุขู ุฅุบูุงู ูุฐู ุงูุทุฑููุฉ."
                exit 0
                ;;
            "ุฅููุงู ุงูุฎุงุฏู ูุชูุธูู ุงููููุงุช ุงููุคูุชุฉ (Stop & Cleanup)")
                stop_server
                cleanup_data
                echo "ุชู ุงูุฅุบูุงู ุงูุขูู ูุงูุชูุธูู. ููููู ุงูุขู ุฅุบูุงู ูุฐู ุงูุทุฑููุฉ."
                exit 0
                ;;
            "ุฅูุบุงุก ุงูุฃูุฑ ูุงูุนูุฏุฉ (Cancel & Continue)")
                echo "ุงูุนูุฏุฉ ุฅูู ุงูุนูู. ุฑุงูุจ ูุฐู ุงููุงูุฐุฉ ูุฑุคูุฉ ูุฎุฑุฌุงุช ุงูุฎุงุฏู."
                break
                ;;
            *)
                echo "ุงุฎุชูุงุฑ ุบูุฑ ุตุงูุญ. ุญุงูู ูุฌุฏุฏุงู."
                ;;
        esac
    done
    # ุงูุงูุชุธุงุฑ ุญุชู ูุญุฏุซ ุดูุก ูู ุงูุฎุงุฏู ุฃู ูุถุบุท ุงููุณุชุฎุฏู ุนูู ุฎูุงุฑ ุขุฎุฑ
    sleep 3
done
