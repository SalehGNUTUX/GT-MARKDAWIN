#!/bin/bash

# =======================================================
# GT-MARKDAWIN Unified Launcher, Stopper, and Cleaner
# =======================================================

PORT=8000
# ๐ ุงูุชุนุฏูู ููุง ูุชุถููู index.html ๐
SERVER_ADDRESS="http://127.0.0.1:$PORT/index.html"
PID_FILE="server.pid"

# ๐ ุงูุชุญุฏูุฏ ุงูุชููุงุฆู ููุณุงุฑ ุงูุจูุงูุงุช ุงููุคูุชุฉ ๐
BASE_DIR="${APPDIR:-.}"
DATA_DIR="$BASE_DIR/mnt/GTMarkdawinData"

# -------------------------------------------------------
# ุฏุงูุฉ ุฅููุงู ุงูุฎุงุฏู
# -------------------------------------------------------
stop_server() {
    echo "=========================================="
    echo "๐ ุฌุงุฑู ุฅููุงู ุงูุฎุงุฏู..."

    if [ -f "$PID_FILE" ]; then
        SERVER_PID=$(cat "$PID_FILE")
        echo "ุฅุฑุณุงู ุฅุดุงุฑุฉ ุงูุฅููุงู (SIGTERM) ุฅูู ุงูุนูููุฉ $SERVER_PID..."
        kill -TERM "$SERVER_PID" 2>/dev/null

        sleep 1
        if ! kill -0 "$SERVER_PID" 2> /dev/null; then
            echo "โ ุชู ุฅููุงู ุงูุฎุงุฏู ุจูุฌุงุญ."
            rm -f "$PID_FILE"
            return 0
        else
            echo "โ๏ธ ูุดู ุงูุฅููุงู ุจู SIGTERM. ุงูุฅููุงู ุงููุณุฑู (SIGKILL)."
            kill -9 "$SERVER_PID" 2>/dev/null
            rm -f "$PID_FILE"
            return 0
        fi
    else
        echo "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ููู PID. ุงูุฎุงุฏู ูู ูุชู ุชุดุบููู ุฃู ุชู ุฅููุงูู ูุณุจูุงู."
        return 1
    fi
}

# -------------------------------------------------------
# ุฏุงูุฉ ุชูุธูู ุงููููุงุช
# -------------------------------------------------------
cleanup_data() {
    echo "------------------------------------------"
    if [ -d "$DATA_DIR" ]; then
        echo "๐๏ธ ุชูุธูู ูุญุชููุงุช ุงููุฌูุฏ ุงููุคูุช: $DATA_DIR"
        rm -rf "$DATA_DIR"/*
        if [ $? -eq 0 ]; then
            echo "โ ุชู ุฅูุฑุงุบ ูุญุชููุงุช $DATA_DIR ุจูุฌุงุญ."
        else
            echo "โ ูุดูุช ุนูููุฉ ุงูุชูุธูู."
        fi
    else
        echo "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฌูุฏ ุงูุจูุงูุงุช: $DATA_DIR. ุชุฎุทู ุนูููุฉ ุงูุชูุธูู."
    fi
    echo "=========================================="
}

# -------------------------------------------------------
# 1. ูุฑุญูุฉ ุงูุชุดุบูู (RUN)
# -------------------------------------------------------
echo "=========================================="
echo "๐ GT-MARKDAWIN: ุชุดุบูู ุงูุฎุงุฏู ุงููุญูู"
echo "=========================================="
echo "ุงููุณุงุฑ ุงููุคูุช ุงููููุชุดู: $DATA_DIR"
echo "ุงูุฑุฌุงุก ุนุฏู ุฅุบูุงู ูุฐู ุงููุงูุฐุฉ."

# ุชุดุบูู ุงูุฎุงุฏู ุงููุญูู ุจุงุณุชุฎุฏุงู ุจุงูุซูู 3 ูู ุงูุฎูููุฉ (&)
python3 -m http.server $PORT &
echo $! > "$PID_FILE"
echo "ุชุดุบูู ุฎุงุฏู ุจุงูุซูู 3 HTTP ุนูู ุงููููุฐ $PORT. ูุนุฑูู ุงูุนูููุฉ: $(cat $PID_FILE)"

# ูุชุญ ุงููุชุตูุญ
if command -v xdg-open > /dev/null; then
    xdg-open "$SERVER_ADDRESS"
elif command -v open > /dev/null; then
    open "$SERVER_ADDRESS"
else
    echo "ุงูุฑุฌุงุก ูุชุญ ุงููุชุตูุญ ูุฏููุงู ุนูู: $SERVER_ADDRESS"
fi

echo "=========================================="
echo "ุงูุนูููุงุช ุงูุฏุงุฎููุฉ ููุฎุงุฏู ุณุชุธูุฑ ููุง..."
echo "=========================================="

# -------------------------------------------------------
# 2. ุญููุฉ ุงูุฅุบูุงู ูุงูุฎูุงุฑุงุช (SHUTDOWN LOOP)
# -------------------------------------------------------
PS3='ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุฅุฌุฑุงุก ุงููุทููุจ: '
options=("ุฅููุงู ุงูุฎุงุฏู ููุท (Stop Server Only)" "ุฅููุงู ุงูุฎุงุฏู ูุชูุธูู ุงููููุงุช ุงููุคูุชุฉ (Stop & Cleanup)" "ุฅูุบุงุก ุงูุฃูุฑ ูุงูุนูุฏุฉ (Cancel & Continue)")

# ุญููุฉ ุนุฑุถ ูุงุฆูุฉ ุงูุงุฎุชูุงุฑุงุช
while true; do
    echo ""
    echo "=========================================="
    echo "ุฎูุงุฑุงุช ุงูุฅุบูุงู: (ุงุถุบุท ุงูุฑูู ุซู Enter)"
    select choice in "${options[@]}"; do
        case $choice in
            "ุฅููุงู ุงูุฎุงุฏู ููุท (Stop Server Only)")
                stop_server
                echo "ุชู ุงูุฅุบูุงู. ููููู ุงูุขู ุฅุบูุงู ูุฐู ุงูุทุฑููุฉ."
                exit 0
                ;;
            "ุฅููุงู ุงูุฎุงุฏู ูุชูุธูู ุงููููุงุช ุงููุคูุชุฉ (Stop & Cleanup)")
                stop_server
                cleanup_data
                echo "ุชู ุงูุฅุบูุงู ุงูุขูู ูุงูุชูุธูู. ููููู ุงูุขู ุฅุบูุงู ูุฐู ุงูุทุฑููุฉ."
                exit 0
                ;;
            "ุฅูุบุงุก ุงูุฃูุฑ ูุงูุนูุฏุฉ (Cancel & Continue)")
                echo "ุงูุนูุฏุฉ ุฅูู ุงูุนูู. ุฑุงูุจ ูุฐู ุงููุงูุฐุฉ ูุฑุคูุฉ ูุฎุฑุฌุงุช ุงูุฎุงุฏู."
                break
                ;;
            *)
                echo "ุงุฎุชูุงุฑ ุบูุฑ ุตุงูุญ. ุญุงูู ูุฌุฏุฏุงู."
                ;;
        esac
    done
    sleep 5
done
